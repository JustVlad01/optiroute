<div class="excel-import-container">
  <!-- Simple header with back button -->
  <header class="app-header">
    <a routerLink="/" class="back-link">
      <i class="bi bi-arrow-left"></i>
    </a>
    <div class="logo">OPTIROUTE</div>
  </header>

  <div class="content-wrapper">
    <div class="card import-card">
      <div class="card-body import-section">
        <h2 class="section-title">Import Excel Data</h2>
        <p class="section-description">Upload your Excel file containing store order data</p>
        
        <!-- File input section -->
        <div class="file-input-section">
          <!-- Hidden file input -->
          <input
            type="file"
            id="excel-file"
            (change)="onFileSelected($event)"
            accept=".xlsx, .xls"
            [disabled]="loading"
            #fileInput
            hidden
          />
          
          <!-- Upload button -->
          <button 
            class="btn btn-primary upload-btn"
            (click)="fileInput.click()" 
            [disabled]="loading"
          >
            <i class="bi bi-cloud-upload-fill me-2"></i>
            Select Excel File
          </button>
          
          <!-- Selected file display -->
          <div *ngIf="fileName" class="selected-file-container">
            <span class="selected-file-name">{{ fileName }}</span>
            <button 
              class="btn btn-sm btn-light clear-btn" 
              (click)="resetForm()" 
              [disabled]="loading"
            >
              <i class="bi bi-x"></i>
            </button>
          </div>
        </div>

        <!-- Loading indicator -->
        <div *ngIf="loading" class="loading-indicator mt-4">
          <div class="progress">
            <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 100%"></div>
          </div>
          <p class="text-center text-muted mt-2">Processing data, please wait...</p>
        </div>
      </div>
    </div>

    <!-- Route Selection Section -->
    <div *ngIf="routeGroups.length > 0 && !displayImportedStores" class="card mt-4">
      <div class="card-body">
        <h2 class="section-title">Route Selection</h2>
        <p class="section-description">Select a route to view its stores:</p>
        
        <div class="form-group mb-4">
          <select 
            class="form-select route-select" 
            [(ngModel)]="selectedRoute" 
            (change)="onRouteSelectionChange()"
          >
            <option value="" disabled selected>Select Route</option>
            <option *ngFor="let route of routeGroups" [value]="route.routeName">
              {{ route.routeName }} ({{ route.storeCount }} stores)
            </option>
          </select>
        </div>
        
        <!-- Selected route stores table -->
        <div *ngIf="selectedRouteStores.length > 0" class="selected-route-details">
          <div class="route-header d-flex justify-content-between align-items-center mb-3 pb-2 border-bottom">
            <h4 class="route-title mb-0">{{ selectedRoute }}</h4>
            <div class="route-stats d-flex gap-3">
              <div class="stat-badge" title="{{ selectedRouteStores.length }} stores">
                <i class="bi bi-shop me-1"></i> {{ selectedRouteStores.length }}
              </div>
              <div class="stat-badge" title="{{ getRouteTotalItemsByName(selectedRoute) }} items">
                <i class="bi bi-box-seam me-1"></i> {{ getRouteTotalItemsByName(selectedRoute) }}
              </div>
              <div class="stat-badge" title="{{ getRouteTotalCratesByName(selectedRoute) }} crates">
                <i class="bi bi-grid-3x3 me-1"></i> {{ getRouteTotalCratesByName(selectedRoute) }}
              </div>
            </div>
          </div>
          
          <div class="table-responsive">
            <table class="table table-hover data-table">
              <thead>
                <tr>
                  <th>Store</th>
                  <th class="text-end">Quantity</th>
                  <th class="text-end">Crates</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let store of selectedRouteStores">
                  <td title="{{store.storeName}}">{{ store.storeName }}</td>
                  <td class="text-end" title="{{store.totalQuantity}}">{{ store.totalQuantity }}</td>
                  <td class="text-end" title="{{store.cratesNeeded}}">{{ store.cratesNeeded }}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        
        <!-- Action buttons section -->
        <div class="action-buttons mt-4 d-flex justify-content-end gap-3">
          <button 
            class="btn btn-primary save-btn"
            (click)="openConfirmDialog()" 
            [disabled]="loading || routeGroups.length === 0"
          >
            <i class="bi bi-database-fill me-2"></i>
            Save to Database
          </button>
          
          <button 
            class="btn btn-outline-secondary reset-btn"
            (click)="resetForm()" 
            [disabled]="loading"
          >
            <i class="bi bi-arrow-counterclockwise me-2"></i>
            Reset
          </button>
        </div>
      </div>
    </div>

    <!-- Imported stores section -->
    <div *ngIf="displayImportedStores && !displayMatchedStores" class="card mt-4">
      <div class="card-body">
        <h2 class="section-title">Imported Stores by Route</h2>
        <p class="section-description">Your data has been successfully imported and organized by routes</p>

        <!-- Route groups with accordion -->
        <div class="accordion accordion-flush" id="routeAccordion">
          <div class="accordion-item" *ngFor="let route of groupedImportedStores; let i = index">
            <h2 class="accordion-header" id="heading{{i}}">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" [attr.data-bs-target]="'#collapse'+i" aria-expanded="false" [attr.aria-controls]="'collapse'+i">
                <div class="d-flex justify-content-between align-items-center w-100">
                  <span class="route-accordion-title">{{ route.routeName }}</span>
                  <div class="route-stats-badges d-flex gap-3">
                    <div class="stat-badge"><i class="bi bi-shop me-1"></i> {{ route.stores.length }}</div>
                    <div class="stat-badge"><i class="bi bi-box-seam me-1"></i> {{ getTotalQuantity(route) }}</div>
                    <div class="stat-badge"><i class="bi bi-grid-3x3 me-1"></i> {{ getTotalCrates(route) }}</div>
                  </div>
                </div>
              </button>
            </h2>
            
            <div id="collapse{{i}}" class="accordion-collapse collapse" [attr.aria-labelledby]="'heading'+i" data-bs-parent="#routeAccordion">
              <div class="accordion-body">
                <!-- Table for stores within this route -->
                <div class="table-responsive">
                  <table class="table table-hover data-table">
                    <thead>
                      <tr>
                        <th>Store Name</th>
                        <th class="text-end">Quantity</th>
                        <th class="text-end">Crates</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr *ngFor="let store of route.stores">
                        <td>{{ store.store_name }}</td>
                        <td class="text-end">{{ store.total_quantity }}</td>
                        <td class="text-end">{{ store.crates_needed }}</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Button to match stores with master database -->
        <div class="mt-4 d-flex justify-content-end gap-3">
          <button 
            class="btn btn-primary match-btn"
            (click)="matchStores()" 
            [disabled]="loading"
          >
            <i class="bi bi-link-45deg me-2"></i>
            Match Stores with Database
          </button>
          
          <button 
            class="btn btn-outline-primary match-btn"
            (click)="matchStoresImproved()" 
            [disabled]="loading"
            title="Uses fuzzy matching with lower threshold to match more stores"
          >
            <i class="bi bi-link-45deg me-2"></i>
            Advanced Matching
          </button>
          
          <button 
            class="btn btn-outline-secondary reset-btn"
            (click)="resetForm()" 
            [disabled]="loading"
          >
            <i class="bi bi-plus-circle me-2"></i>
            Import New File
          </button>
        </div>
      </div>
    </div>

    <!-- Matched stores results section -->
    <div *ngIf="displayMatchedStores" class="card mt-4">
      <div class="card-body">
        <h2 class="section-title">Store Matching Results</h2>
        <p class="section-description">
          Successfully matched {{ matchResults?.totalMatched }} out of {{ matchResults?.totalProcessed }} stores
        </p>

        <!-- Tabs for matched and unmatched stores -->
        <ul class="nav nav-tabs mb-4" id="matchTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button 
              class="nav-link active" 
              id="matched-tab" 
              data-bs-toggle="tab" 
              data-bs-target="#matched" 
              type="button" 
              role="tab" 
              aria-controls="matched" 
              aria-selected="true">
              Matched Stores ({{ matchResults?.matchedStores?.length || 0 }})
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button 
              class="nav-link" 
              id="unmatched-tab" 
              data-bs-toggle="tab" 
              data-bs-target="#unmatched" 
              type="button" 
              role="tab" 
              aria-controls="unmatched" 
              aria-selected="false">
              Unmatched Stores ({{ matchResults?.unmatchedStores?.length || 0 }})
            </button>
          </li>
        </ul>

        <!-- Tab content -->
        <div class="tab-content" id="matchTabsContent">
          <!-- Matched stores tab -->
          <div class="tab-pane fade show active" id="matched" role="tabpanel" aria-labelledby="matched-tab">
            <div class="table-responsive">
              <table class="table table-striped table-hover">
                <thead>
                  <tr>
                    <th>Excel Store Name</th>
                    <th>Master Store Name</th>
                    <th>Match Confidence</th>
                    <th>Route</th>
                    <th>Dispatch Code</th>
                    <th>Address</th>
                    <th class="text-end">Quantity</th>
                    <th class="text-end">Crates</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let store of matchResults?.matchedStores">
                    <td>{{ store.excel_store_name }}</td>
                    <td>{{ store.master_store_name }}</td>
                    <td>
                      <div class="badge" [ngClass]="{
                        'bg-success': store.match_confidence > 0.8,
                        'bg-primary': store.match_confidence > 0.5 && store.match_confidence <= 0.8,
                        'bg-warning text-dark': store.match_confidence <= 0.5
                      }">
                        {{ (store.match_confidence * 100).toFixed(0) }}%
                      </div>
                    </td>
                    <td>{{ store.route_name }}</td>
                    <td>{{ store.dispatch_code }}</td>
                    <td>{{ store.address_line }}</td>
                    <td class="text-end">{{ store.total_quantity }}</td>
                    <td class="text-end">{{ store.crates_needed }}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
          
          <!-- Unmatched stores tab -->
          <div class="tab-pane fade" id="unmatched" role="tabpanel" aria-labelledby="unmatched-tab">
            <div class="table-responsive">
              <table class="table table-striped table-hover">
                <thead>
                  <tr>
                    <th>Store Name</th>
                    <th>Route</th>
                    <th class="text-end">Quantity</th>
                    <th class="text-end">Crates</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let store of matchResults?.unmatchedStores">
                    <td>{{ store.store_name }}</td>
                    <td>{{ store.route_name }}</td>
                    <td class="text-end">{{ store.total_quantity }}</td>
                    <td class="text-end">{{ store.crates_needed }}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Button to go back to imports -->
        <div class="mt-4 d-flex justify-content-end">
          <button 
            class="btn btn-primary"
            (click)="resetForm()" 
            [disabled]="loading"
          >
            <i class="bi bi-plus-circle me-2"></i>
            Import New File
          </button>
        </div>
      </div>
    </div>
  </div>
</div> 