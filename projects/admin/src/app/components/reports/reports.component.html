<div class="reports-container">
  <!-- Professional Navbar -->
  <div class="navbar">
    <div class="logo">
      <div class="main-title">Around Noon</div>
      
    </div>
    <div class="nav-links">
      <a class="nav-pill" (click)="navigateToDashboard()">
        <i class="bi bi-house-fill"></i> Back to Dashboard
      </a>
    </div>
  </div>

  <!-- Navigation Tabs -->
  <div class="nav-tabs-container">
    <div class="nav-tabs">
      <button 
        [class.active]="activeTab === 'accident-reports'"
        (click)="setActiveTab('accident-reports')"
      >
        <i class="bi bi-file-text"></i> Vehicle Accident Reports
      </button>
      <button 
        [class.active]="activeTab === 'driver-updates'"
        (click)="setActiveTab('driver-updates')"
      >
        <i class="bi bi-truck"></i> Driver Delivery Updates
      </button>
      <button 
        [class.active]="activeTab === 'van-issues'"
        (click)="setActiveTab('van-issues')"
      >
        <i class="bi bi-exclamation-triangle"></i> Van Issues Report
        <span class="notification-badge" *ngIf="getVanIssuesPendingCount() > 0">
          {{ getVanIssuesPendingCount() }}
        </span>
      </button>
      <button 
        [class.active]="activeTab === 'rejected-orders'"
        (click)="setActiveTab('rejected-orders')"
      >
        <i class="bi bi-x-circle"></i> Rejected Orders
      </button>
      <button 
        [class.active]="activeTab === 'temperature-reports'"
        (click)="setActiveTab('temperature-reports')"
      >
        <i class="bi bi-thermometer-half"></i> Temperature Issue Report
      </button>
    </div>
  </div>

  <div class="content">
    <!-- Accident Reports Tab Content -->
    <div *ngIf="activeTab === 'accident-reports'" class="tab-content">
      <!-- List View -->
      <div *ngIf="viewMode === 'list'">
        <!-- Filters Section -->
        <div class="filters-section">
          <div class="filters-row">
            <div class="filter-group">
              <label for="searchTerm">Search Reports</label>
              <input
                type="text"
                id="searchTerm"
                [(ngModel)]="searchTerm"
                (input)="onFilterChange()"
                placeholder="Search by driver name or vehicle registration..."
                class="filter-input"
              >
            </div>
            
            <div class="filter-group">
              <label for="dateFilter">Filter by Date</label>
              <input
                type="date"
                id="dateFilter"
                [(ngModel)]="dateFilter"
                (change)="onFilterChange()"
                class="filter-input"
              >
            </div>
            
            <div class="filter-actions">
              <button class="btn-refresh" (click)="refreshReports()">
                <i class="bi bi-arrow-clockwise"></i>
                Refresh
              </button>
              <button class="btn-export" (click)="exportReports()">
                <i class="bi bi-download"></i>
                Export CSV
              </button>
            </div>
          </div>
        </div>

        <!-- Loading State -->
        <div *ngIf="isLoading" class="loading-state">
          <div class="spinner"></div>
          <p>Loading accident reports...</p>
        </div>

        <!-- Error State -->
        <div *ngIf="error" class="error-state">
          <i class="bi bi-exclamation-triangle"></i>
          <p>{{ error }}</p>
          <button class="btn-retry" (click)="loadReports()">
            <i class="bi bi-arrow-clockwise"></i>
            Try Again
          </button>
        </div>

        

        <!-- Reports Table -->
        <div *ngIf="!isLoading && !error && filteredReports.length > 0" class="reports-table-container">
          <table class="reports-table">
            <thead>
              <tr>
                <th>Report ID</th>
                <th>Date Submitted</th>
                <th>Collision Date</th>
                <th>Driver Name</th>
                <th>Vehicle Details</th>
                <th>Other Vehicle</th>
                <th>Location</th>
                <th>Images</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let report of paginatedReports">
                <td class="report-id">#{{ report.id }}</td>
                <td>{{ formatDate(report.created_at) }}</td>
                <td>{{ report.date_of_collision }}</td>
                <td>{{ report.my_driver_name || 'Not provided' }}</td>
                <td>
                  <div class="vehicle-info">
                    <div>{{ report.my_vehicle_make || 'N/A' }}</div>
                    <small>{{ report.my_vehicle_registration || 'N/A' }}</small>
                  </div>
                </td>
                <td>
                  <div class="vehicle-info">
                    <div>{{ report.other_vehicle_make || 'N/A' }}</div>
                    <small>{{ report.other_vehicle_registration || 'N/A' }}</small>
                  </div>
                </td>
                <td>
                  <div class="location-info">
                    <span>{{ formatLocation(report.location_of_collision) }}</span>
                    <button 
                      *ngIf="report.location_of_collision" 
                      class="btn-map" 
                      (click)="openInGoogleMaps(report.location_of_collision)"
                      title="Open in Google Maps"
                    >
                      <i class="bi bi-geo-alt"></i>
                      Maps
                    </button>
                  </div>
                </td>
                <td class="images-cell">
                  <div class="images-info">
                    <i class="bi bi-camera"></i>
                    {{ report.images?.length || 0 }}
                  </div>
                </td>
                <td class="actions-cell">
                  <div class="action-buttons">
                    <button 
                      class="btn-view" 
                      (click)="viewReportDetails(report)"
                      title="View Details"
                    >
                      <i class="bi bi-eye"></i>
                      View
                    </button>
                    <button 
                      class="btn-pdf" 
                      (click)="downloadPDF(report)"
                      title="Download PDF"
                    >
                      <i class="bi bi-file-pdf"></i>
                      PDF
                    </button>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Empty State -->
        <div *ngIf="!isLoading && !error && filteredReports.length === 0" class="empty-state">
          <i class="bi bi-file-text"></i>
          <h3>No accident reports found</h3>
          <p *ngIf="searchTerm || dateFilter">Try adjusting your search criteria.</p>
          <p *ngIf="!searchTerm && !dateFilter">No accident reports have been submitted yet.</p>
        </div>

        <!-- Pagination -->
        <div *ngIf="!isLoading && !error && filteredReports.length > 0" class="pagination">
          <button 
            class="btn-page" 
            [disabled]="currentPage === 1"
            (click)="onPageChange(currentPage - 1)"
          >
            <i class="bi bi-chevron-left"></i>
            Previous
          </button>
          
          <span class="page-info">
            Page {{ currentPage }} of {{ totalPages }}
          </span>
          
          <button 
            class="btn-page" 
            [disabled]="currentPage === totalPages"
            (click)="onPageChange(currentPage + 1)"
          >
            Next
            <i class="bi bi-chevron-right"></i>
          </button>
        </div>
      </div>

      <!-- Detail View -->
      <div *ngIf="viewMode === 'detail' && selectedReport" class="detail-view">
        <div class="detail-header">
          <h2>Accident Report #{{ selectedReport.id }}</h2>
          <div class="report-meta">
            <div class="report-date">
              Submitted: {{ selectedReport.created_at | date:'dd/MM/yyyy HH:mm' }}
            </div>
            <div class="d-flex gap-2 mt-2">
              <button class="btn btn-secondary btn-sm" (click)="backToList()">
                <i class="bi bi-arrow-left"></i> Back to List
              </button>
              <button 
                class="btn btn-primary btn-sm" 
                (click)="downloadPDF(selectedReport)"
                title="Download PDF Report">
                <i class="bi bi-file-earmark-pdf"></i> Download PDF
              </button>
            </div>
          </div>
        </div>

        <div class="detail-content">
          <!-- Basic Information -->
          <div class="detail-section">
            <h3><i class="bi bi-info-circle"></i> Basic Information</h3>
            <div class="detail-grid">
              <div class="detail-item">
                <label>Report ID:</label>
                <span>#{{ selectedReport.id }}</span>
              </div>
              <div class="detail-item">
                <label>Date Created:</label>
                <span>{{ formatDate(selectedReport.created_at) }}</span>
              </div>
              <div class="detail-item">
                <label>Collision Date:</label>
                <span>{{ selectedReport.date_of_collision }}</span>
              </div>
              <div class="detail-item">
                <label>Location:</label>
                <span>{{ formatLocation(selectedReport.location_of_collision) }}</span>
                <div *ngIf="selectedReport.location_of_collision" class="location-actions mt-1">
                  <button 
                    class="btn btn-outline-info btn-sm" 
                    (click)="openInGoogleMaps(selectedReport.location_of_collision)"
                    title="Open in Google Maps">
                    <i class="bi bi-geo-alt"></i> View on Google Maps
                  </button>
                </div>
              </div>
              <div class="detail-item">
                <label>Session ID:</label>
                <span>{{ selectedReport.session_id }}</span>
              </div>
            </div>
          </div>

          <!-- My Vehicle Information -->
          <div class="detail-section">
            <h3><i class="bi bi-car-front"></i> My Vehicle Information</h3>
            <div class="detail-grid">
              <div class="detail-item">
                <label>Driver Name:</label>
                <span>{{ selectedReport.my_driver_name || 'N/A' }}</span>
              </div>
              <div class="detail-item">
                <label>Vehicle Make:</label>
                <span>{{ selectedReport.my_vehicle_make || 'N/A' }}</span>
              </div>
              <div class="detail-item">
                <label>Registration:</label>
                <span>{{ selectedReport.my_vehicle_registration || 'N/A' }}</span>
              </div>
              <div class="detail-item">
                <label>Colour:</label>
                <span>{{ selectedReport.my_vehicle_colour || 'N/A' }}</span>
              </div>
            </div>
          </div>

          <!-- Other Vehicle Information -->
          <div class="detail-section">
            <h3><i class="bi bi-car-front-fill"></i> Other Vehicle Information</h3>
            <div class="detail-grid">
              <div class="detail-item">
                <label>Driver Name:</label>
                <span>{{ selectedReport.other_driver_name || 'N/A' }}</span>
              </div>
              <div class="detail-item">
                <label>Vehicle Make:</label>
                <span>{{ selectedReport.other_vehicle_make || 'N/A' }}</span>
              </div>
              <div class="detail-item">
                <label>Registration:</label>
                <span>{{ selectedReport.other_vehicle_registration || 'N/A' }}</span>
              </div>
              <div class="detail-item">
                <label>Colour:</label>
                <span>{{ selectedReport.other_vehicle_colour || 'N/A' }}</span>
              </div>
            </div>
          </div>

          <!-- Damage and Injuries -->
          <div class="detail-section">
            <h3><i class="bi bi-exclamation-triangle"></i> Damage and Injuries</h3>
            <div class="detail-grid">
              <div class="detail-item full-width">
                <label>Other Vehicle Damage:</label>
                <span>{{ selectedReport.other_damage_description || 'No damage description provided' }}</span>
              </div>
              <div class="detail-item full-width">
                <label>My Injuries:</label>
                <span>{{ selectedReport.my_injuries || 'No injuries reported' }}</span>
              </div>
            </div>
          </div>

          <!-- Images -->
          <div *ngIf="selectedReport.images && selectedReport.images.length > 0" class="detail-section">
            <h3><i class="bi bi-images"></i> Accident Images ({{ selectedReport.images.length }})</h3>
            <div class="images-grid">
              <div *ngFor="let image of selectedReport.images" class="image-item">
                <img [src]="image.storage_bucket_url" 
                     [alt]="image.original_filename"
                     class="accident-image"
                     (click)="openImageModal(image.storage_bucket_url)">
                <div class="image-info">
                  <span class="image-filename">{{ image.original_filename }}</span>
                  <span class="image-date">{{ formatDate(image.uploaded_at) }}</span>
                </div>
              </div>
            </div>
          </div>

          <div *ngIf="!selectedReport.images || selectedReport.images.length === 0" class="detail-section">
            <h3><i class="bi bi-images"></i> Accident Images</h3>
            <div class="empty-images">
              <i class="bi bi-image"></i>
              <p>No images were uploaded with this report.</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Driver Updates Tab Content -->
    <div *ngIf="activeTab === 'driver-updates'" class="tab-content">
      <!-- Date Range Selector -->
      <div class="date-range-selector">
        <div class="date-range-header">
          <h4><i class="bi bi-calendar-range"></i> Export Date Range</h4>
          <p>Select a custom date range to export driver updates</p>
        </div>
        <div class="date-range-controls">
          <div class="date-input-group">
            <label for="exportStartDate">From Date:</label>
            <input 
              type="date" 
              id="exportStartDate" 
              [(ngModel)]="exportStartDate"
              class="date-input"
            >
          </div>
          <div class="date-input-group">
            <label for="exportEndDate">To Date:</label>
            <input 
              type="date" 
              id="exportEndDate" 
              [(ngModel)]="exportEndDate"
              class="date-input"
            >
          </div>
          <div class="export-actions">
            <button 
              class="btn-export-range" 
              (click)="exportDateRange()"
              [disabled]="!exportStartDate || !exportEndDate"
            >
              <i class="bi bi-file-earmark-pdf"></i>
              Export Range
            </button>
            <button 
              class="btn-quick-range" 
              (click)="setQuickRange('week')"
            >
              Last Week
            </button>
            <button 
              class="btn-quick-range" 
              (click)="setQuickRange('month')"
            >
              Last Month
            </button>
          </div>
        </div>
      </div>

      <!-- Loading State -->
      <div *ngIf="driverLoading" class="loading-state">
        <div class="spinner"></div>
        <p>Loading driver updates...</p>
      </div>

      <!-- No Data State -->
      <div *ngIf="!driverLoading && dayGroups.length === 0" class="empty-state">
        <i class="bi bi-truck"></i>
        <h3>No Driver Updates Found</h3>
        <p>No delivery updates have been submitted for the selected period.</p>
      </div>

      <!-- Driver Updates Table -->
      <div *ngIf="!driverLoading && dayGroups.length > 0" class="reports-table-container">
        <table class="reports-table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Updates Count</th>
              <th>Outstanding</th>
              <th>Notifications</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <ng-container *ngFor="let dayGroup of dayGroups">
              <tr class="day-group-row">
                <td>
                  <div class="date-info" (click)="toggleDayExpansion(dayGroup)" style="cursor: pointer;">
                    <div class="day-header-content">
                      <i class="bi" [class.bi-chevron-down]="dayGroup.isExpanded" [class.bi-chevron-right]="!dayGroup.isExpanded"></i>
                      {{ dayGroup.displayDate }}
                    </div>
                    <small>{{ dayGroup.updates.length }} updates</small>
                  </div>
                </td>
                <td>{{ dayGroup.updates.length }}</td>
                <td>
                  <span class="stat-badge outstanding">
                    <i class="bi bi-box-seam"></i>
                    {{ getOutstandingDeliveriesForDay(dayGroup) }}
                  </span>
                </td>
                <td>
                  <span class="stat-badge notifications">
                    <i class="bi bi-bell"></i>
                    {{ getAdvancedNotificationsForDay(dayGroup) }}
                  </span>
                </td>
                <td class="actions-cell">
                  <div class="action-buttons">
                    <button class="btn-view" (click)="toggleDayExpansion(dayGroup)">
                      <i class="bi" [class.bi-eye]="!dayGroup.isExpanded" [class.bi-eye-slash]="dayGroup.isExpanded"></i>
                      {{ dayGroup.isExpanded ? 'Hide Details' : 'View Details' }}
                    </button>
                    <button class="btn-export" (click)="exportDayReport(dayGroup)">
                      <i class="bi bi-file-earmark-pdf"></i>
                      Export
                    </button>
                  </div>
                </td>
              </tr>
              
              <!-- Expanded Day Content -->
              <tr *ngIf="dayGroup.isExpanded" class="day-expansion-row">
                <td colspan="5" class="day-expansion-content">
                  <div class="expanded-day-details">
                    <div class="day-content">
                      <div class="updates-grid">
                        <div class="update-card" *ngFor="let update of dayGroup.updates">
                          <div class="update-header">
                            <div class="update-selection">
                              <input 
                                type="checkbox" 
                                [id]="'update-' + dayGroup.date + '-' + update.id" 
                                [checked]="isUpdateSelectedInDay(dayGroup, update.id)"
                                (change)="toggleUpdateInDay(dayGroup, update.id)"
                                class="update-checkbox"
                              >
                            </div>
                            <div class="update-info">
                              <div class="update-time">{{ formatDate(update.created_at) }}</div>
                              <div class="update-driver">{{ update.drivers?.name || 'Unknown' }}</div>
                              <div class="update-route">{{ update.route_name || 'N/A' }}</div>
                            </div>
                            <div class="update-actions">
                              <button class="view-btn" (click)="viewUpdateDetails(update); $event.stopPropagation()">
                                <i class="bi bi-eye"></i> View
                              </button>
                              <div class="action-indicators">
                                <span class="indicator-icon outstanding" *ngIf="getStoreCount(update) > 0" 
                                      [title]="getStoreCount(update) + ' Outstanding Stores'">
                                  <i class="bi bi-box-seam"></i>
                                  <span class="count">{{ getStoreCount(update) }}</span>
                                </span>
                                <span class="indicator-icon notification" *ngIf="update.comments && update.comments.trim().length > 0"
                                      title="Has Advanced Notification">
                                  <i class="bi bi-bell-fill"></i>
                                </span>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </td>
              </tr>
            </ng-container>
          </tbody>
        </table>
      </div>

      <!-- Detail View Mode -->
      <div *ngIf="activeTab === 'driver-updates' && driverViewMode === 'detail' && selectedDriverUpdate" class="update-detail">
        <div class="detail-header">
          <button class="back-btn" (click)="backToDriverList()">
            <i class="bi bi-arrow-left"></i> Back to List
          </button>
          <h3>Update Details - {{ formatDate(selectedDriverUpdate.created_at) }}</h3>
        </div>

        <div class="detail-card">
          <div class="detail-section">
            <div class="section-title">
              <i class="bi bi-info-circle"></i>
              <h4>General Information</h4>
            </div>
            <div class="detail-row">
              <div class="detail-label">Driver:</div>
              <div class="detail-value">{{ selectedDriverUpdate.drivers?.name || 'Unknown' }}</div>
            </div>
            <div class="detail-row">
              <div class="detail-label">Route:</div>
              <div class="detail-value">{{ selectedDriverUpdate.route_name || 'N/A' }}</div>
            </div>
            <div class="detail-row">
              <div class="detail-label">Submitted:</div>
              <div class="detail-value">{{ formatDate(selectedDriverUpdate.created_at) }}</div>
            </div>
            <div class="detail-row">
              <div class="detail-label">Last Updated:</div>
              <div class="detail-value">{{ formatDate(selectedDriverUpdate.updated_at) }}</div>
            </div>
          </div>

          <div class="detail-section" *ngIf="selectedDriverUpdate.comments">
            <div class="section-title">
              <i class="bi bi-chat-left-text"></i>
              <h4>Advanced Notification Comments</h4>
            </div>
            <div class="comments-box">
              {{ selectedDriverUpdate.comments || 'No comments provided' }}
            </div>
          </div>

          <div class="detail-section" *ngIf="selectedDriverUpdate.delivery_data?.length > 0">
            <div class="section-title">
              <i class="bi bi-box-seam"></i>
              <h4>Delivery Update - Outstanding Deliveries</h4>
            </div>
            <div class="select-actions" *ngIf="getAllStoresFromDeliveries().length > 0">
              <button class="select-btn" (click)="selectAllStores()">
                <i class="bi bi-check-all"></i> Select All
              </button>
              <button class="select-btn" (click)="deselectAllStores()">
                <i class="bi bi-x"></i> Deselect All
              </button>
            </div>
            <div class="delivery-list">
              <div class="delivery-item" *ngFor="let delivery of selectedDriverUpdate.delivery_data; let deliveryIndex = index">
                <div class="delivery-header">
                  <span class="delivery-name">{{ delivery.shop_name }}</span>
                  <span class="delivery-time">{{ delivery.delivery_time }}</span>
                </div>
                
                <div class="store-list" *ngIf="delivery.stores?.length > 0">
                  <div class="store-item" *ngFor="let store of delivery.stores; let storeIndex = index">
                    <div class="store-selector">
                      <input 
                        type="checkbox" 
                        [id]="'store-' + deliveryIndex + '-' + storeIndex" 
                        [checked]="isStoreSelected(deliveryIndex, storeIndex)" 
                        (change)="toggleStoreSelection(deliveryIndex, storeIndex)"
                      >
                      <label [for]="'store-' + deliveryIndex + '-' + storeIndex">{{ store.store_name }}</label>
                    </div>
                    <span class="store-code">{{ store.store_code || 'N/A' }}</span>
                  </div>
                </div>
                
                <div class="no-stores" *ngIf="!delivery.stores || delivery.stores.length === 0">
                  No stores added for this shop
                </div>
              </div>
            </div>
          </div>

          <div class="detail-section" *ngIf="selectedDriverUpdate.last_delivery_times">
            <div class="section-title">
              <i class="bi bi-clock-history"></i>
              <h4>Last Delivery Times</h4>
            </div>
            <div class="last-delivery-list">
              <div class="last-delivery-item" *ngFor="let time of selectedDriverUpdate.last_delivery_times | keyvalue">
                <span class="shop-name">{{ time.key }}:</span>
                <span class="delivery-time">{{ time.value }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Van Issues Tab Content -->
    <div *ngIf="activeTab === 'van-issues'" class="tab-content">
      <!-- Filters Section -->
      <div class="filters-section">
        <div class="filters-row">
          <div class="filter-group">
            <label for="vanIssuesSearchTerm">Search Issues</label>
            <input
              type="text"
              id="vanIssuesSearchTerm"
              [(ngModel)]="searchTerm"
              (input)="onFilterChange()"
              placeholder="Search by vehicle, driver, or issue description..."
              class="filter-input"
            >
          </div>
          
          <div class="filter-group">
            <label for="vanIssuesDateFilter">Filter by Date</label>
            <input
              type="date"
              id="vanIssuesDateFilter"
              [(ngModel)]="dateFilter"
              (change)="onFilterChange()"
              class="filter-input"
            >
          </div>
          
          <div class="filter-actions">
            <button class="btn-refresh" (click)="refreshReports()">
              <i class="bi bi-arrow-clockwise"></i>
              Refresh
            </button>
            <button class="btn-export" (click)="generateVanIssuesQuickReport('all')">
              <i class="bi bi-download"></i>
              Export All
            </button>
          </div>
        </div>
      </div>

      <!-- Loading State -->
      <div *ngIf="vanIssuesLoading" class="loading-state">
        <div class="spinner"></div>
        <p>Loading van issues...</p>
      </div>

      <!-- No Issues State -->
      <div *ngIf="!vanIssuesLoading && (searchTerm || dateFilter ? filteredVanIssues.length === 0 : vanIssues.length === 0)" class="empty-state">
        <i class="bi bi-shield-check" *ngIf="!searchTerm && !dateFilter"></i>
        <i class="bi bi-search" *ngIf="searchTerm || dateFilter"></i>
        <h3 *ngIf="!searchTerm && !dateFilter">No Issues Reported</h3>
        <h3 *ngIf="searchTerm || dateFilter">No Issues Found</h3>
        <p *ngIf="!searchTerm && !dateFilter">All vehicles are currently operating without reported issues.</p>
        <p *ngIf="searchTerm || dateFilter">Try adjusting your search criteria or date filter.</p>
      </div>

      <!-- Van Issues Accordion -->
      <div *ngIf="!vanIssuesLoading && (searchTerm || dateFilter ? filteredVanIssues.length > 0 : vanIssues.length > 0)" class="van-issues-accordion">
        <div class="accordion-item" *ngFor="let issue of paginatedVanIssues; let i = index" 
             [class.verified]="issue.verified"
             [class.expanded]="isIssueExpanded(i)">
          
          <!-- Accordion Header (Collapsed View) -->
          <div class="accordion-header" (click)="toggleIssueExpansion(i)">
            <div class="header-main">
              <div class="vehicle-driver-info">
                <div class="vehicle-badge">{{ issue.van_registration }}</div>
                <div class="driver-name">{{ issue.driver_name }}</div>
                <small class="driver-id">ID: {{ issue.driver_custom_id }}</small>
              </div>
              
              <div class="issue-summary">
                <div class="issue-preview" *ngIf="parseIssuesFromComments(issue.driver_comments, issue.issue_completions).length === 1">
                  {{ parseIssuesFromComments(issue.driver_comments, issue.issue_completions)[0].description | slice:0:100 }}{{ parseIssuesFromComments(issue.driver_comments, issue.issue_completions)[0].description.length > 100 ? '...' : '' }}
                </div>
                <div class="multiple-issues" *ngIf="parseIssuesFromComments(issue.driver_comments, issue.issue_completions).length > 1">
                  <span class="issues-count">{{ parseIssuesFromComments(issue.driver_comments, issue.issue_completions).length }} Issues</span>
                  <span class="remaining-count" *ngIf="getIncompleteIssuesCount(issue) > 0">
                    {{ getIncompleteIssuesCount(issue) }} Remaining
                  </span>
                  <span class="completed-badge" *ngIf="getIncompleteIssuesCount(issue) === 0">
                    <i class="bi bi-check-circle"></i> All Complete
                  </span>
                </div>
              </div>
              
              <div class="header-badges">
                <span class="status-badge" [class.verified]="issue.verified" [class.pending]="!issue.verified">
                  <i class="bi" [class.bi-check-circle-fill]="issue.verified" [class.bi-clock]="!issue.verified"></i>
                  {{ issue.verified ? 'Verified' : 'Pending' }}
                </span>
                <span class="date-badge">{{ formatVanIssueDate(issue.created_at) }}</span>
              </div>
            </div>
            
            <div class="expand-icon" [class.expanded]="isIssueExpanded(i)">
              <i class="fas fa-chevron-down"></i>
            </div>
          </div>
          
          <!-- Accordion Content (Expanded View) -->
          <div class="accordion-content" *ngIf="isIssueExpanded(i)">
            <div class="expanded-details">
              
              <!-- Issue Details Section -->
              <div class="detail-section">
                <h4><i class="bi bi-exclamation-triangle"></i> Issue Details</h4>
                <div class="issues-container">
                  <div class="individual-issues">
                    <div class="issue-item" 
                         *ngFor="let parsedIssue of parseIssuesFromComments(issue.driver_comments, issue.issue_completions); trackBy: trackByIssueIndex"
                         [class.completed]="parsedIssue.completed">
                      <div class="issue-checkbox" *ngIf="parseIssuesFromComments(issue.driver_comments, issue.issue_completions).length > 1">
                        <input type="checkbox" 
                               [id]="'issue-' + issue.id + '-' + parsedIssue.index"
                               [checked]="parsedIssue.completed"
                               (change)="toggleIssueCompletion(issue, parsedIssue.index)"
                               class="completion-checkbox">
                        <label [for]="'issue-' + issue.id + '-' + parsedIssue.index" class="checkbox-label">
                          <i class="bi bi-check" *ngIf="parsedIssue.completed"></i>
                        </label>
                      </div>
                      <div class="issue-description">
                        <span class="issue-number" *ngIf="parseIssuesFromComments(issue.driver_comments, issue.issue_completions).length > 1">
                          {{ parsedIssue.index + 1 }}.
                        </span>
                        <span class="issue-text" [class.completed-text]="parsedIssue.completed">
                          {{ parsedIssue.description }}
                        </span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Images Section -->
              <div class="detail-section" *ngIf="issue.image_urls && issue.image_urls.length > 0">
                <h4><i class="bi bi-camera"></i> Images ({{ issue.image_urls.length }})</h4>
                <div class="image-gallery">
                  <img *ngFor="let imagePath of issue.image_urls.slice(0, 4); trackBy: trackByImagePath"
                       [src]="getImageUrl(imagePath)" 
                       [alt]="'Issue documentation'"
                       (click)="openVanIssueImageModal(getImageUrl(imagePath), issue)"
                       (error)="onImageError($event)"
                       class="thumbnail-image"
                       loading="lazy">
                  <div *ngIf="issue.image_urls.length > 4" class="more-images">
                    +{{ issue.image_urls.length - 4 }} more
                  </div>
                </div>
              </div>
              
              <!-- Repair Receipts Section -->
              <div class="detail-section" *ngIf="issue.repair_receipt_urls && issue.repair_receipt_urls.length > 0">
                <h4><i class="bi bi-receipt"></i> Repair Receipts ({{ issue.repair_receipt_urls.length }})</h4>
                <div class="receipt-gallery">
                  <div *ngFor="let receiptPath of issue.repair_receipt_urls.slice(0, 4); trackBy: trackByReceiptPath" class="receipt-item">
                    <img [src]="getImageUrl(receiptPath)" 
                         [alt]="'Repair receipt'"
                         (click)="openVanIssueImageModal(getImageUrl(receiptPath), issue)"
                         (error)="onImageError($event)"
                         class="thumbnail-receipt"
                         loading="lazy">
                    <button 
                      class="delete-receipt-btn"
                      (click)="deleteReceiptImage(issue, receiptPath); $event.stopPropagation()"
                      title="Delete receipt"
                    >
                      <i class="bi bi-trash"></i>
                    </button>
                  </div>
                  <div *ngIf="issue.repair_receipt_urls.length > 4" class="more-receipts">
                    +{{ issue.repair_receipt_urls.length - 4 }} more
                  </div>
                </div>
              </div>
              
              <!-- Actions Section -->
              <div class="detail-section">
                <h4><i class="bi bi-gear"></i> Actions</h4>
                <div class="action-buttons-expanded">
                  <button 
                    *ngIf="issue.image_urls && issue.image_urls.length > 0"
                    class="btn-view"
                    (click)="openVanIssueImageModal(getImageUrl(issue.image_urls[0]), issue)"
                  >
                    <i class="bi bi-eye"></i>
                    View Images
                  </button>

                  <button 
                    class="upload-receipts-btn"
                    (click)="openReceiptUploadModal(issue)"
                    title="Upload Repair Receipts"
                  >
                    <i class="bi bi-cloud-upload"></i>
                    {{ hasRepairReceipts(issue) ? 'Add More' : 'Upload' }} Receipts
                  </button>

                  <button 
                    *ngIf="!issue.verified"
                    class="btn-pdf"
                    (click)="verifyIssue(issue.id)"
                    [disabled]="isVerifying[issue.id]"
                  >
                    <i class="bi bi-check-circle" *ngIf="!isVerifying[issue.id]"></i>
                    <i class="bi bi-arrow-clockwise spin" *ngIf="isVerifying[issue.id]"></i>
                    {{ isVerifying[issue.id] ? 'Processing...' : 'Mark Seen' }}
                  </button>
                  <span *ngIf="issue.verified" class="verified-label">
                    <i class="bi bi-check-circle-fill"></i>
                    Issue Seen
                  </span>
                </div>
              </div>
              
            </div>
          </div>
        </div>
      </div>

      <!-- Van Issues Pagination -->
      <div *ngIf="!vanIssuesLoading && vanIssuesTotalPages > 1" class="pagination van-issues-pagination">
        <div class="pagination-info">
          <span class="results-count">
            Showing {{ ((vanIssuesCurrentPage - 1) * vanIssuesItemsPerPage) + 1 }} - 
            {{ Math.min(vanIssuesCurrentPage * vanIssuesItemsPerPage, vanIssuesTotalCount) }} 
            of {{ vanIssuesTotalCount }} issues
          </span>
        </div>
        
        <div class="pagination-controls">
          <button 
            class="btn-page" 
            [disabled]="vanIssuesCurrentPage === 1"
            (click)="onVanIssuesPageChange(vanIssuesCurrentPage - 1)"
          >
            <i class="bi bi-chevron-left"></i>
            Previous
          </button>
          
          <div class="page-numbers">
            <button 
              *ngFor="let page of [].constructor(vanIssuesTotalPages); let i = index"
              [class.active]="(i + 1) === vanIssuesCurrentPage"
              class="page-number-btn"
              (click)="onVanIssuesPageChange(i + 1)"
            >
              {{ i + 1 }}
            </button>
          </div>
          
          <button 
            class="btn-page" 
            [disabled]="vanIssuesCurrentPage === vanIssuesTotalPages"
            (click)="onVanIssuesPageChange(vanIssuesCurrentPage + 1)"
          >
            Next
            <i class="bi bi-chevron-right"></i>
          </button>
        </div>
      </div>

      <!-- Van Issue Image Viewer Modal -->
      <div class="modal-overlay" *ngIf="selectedImage" (click)="closeVanIssueImageModal()" role="dialog" aria-modal="true">
        <div class="modal-content" (click)="$event.stopPropagation()">
          <div class="modal-header">
            <h3>Issue Documentation</h3>
            <button class="close-btn" (click)="closeVanIssueImageModal()" aria-label="Close modal">
              <i class="bi bi-x-lg"></i>
            </button>
          </div>
          
          <div class="modal-body">
            <div class="image-container">
              <img [src]="selectedImage" [alt]="'Issue documentation'" class="modal-image" loading="lazy">
            </div>
            
            <div class="issue-details" *ngIf="selectedIssue">
              <div class="detail-row">
                <span class="label">Vehicle:</span>
                <span class="value">{{ selectedIssue.van_registration }}</span>
              </div>
              <div class="detail-row">
                <span class="label">Driver:</span>
                <span class="value">{{ selectedIssue.driver_name }}</span>
              </div>
              <div class="detail-row">
                <span class="label">Reported:</span>
                <span class="value">{{ formatVanIssueDate(selectedIssue.created_at) }}</span>
              </div>
              <div class="detail-row">
                <span class="label">Issue:</span>
                <span class="value">{{ selectedIssue.driver_comments }}</span>
              </div>
            </div>
            
            <div class="image-navigation" *ngIf="selectedIssue && selectedIssue.image_urls && selectedIssue.image_urls.length > 1">
              <div class="thumbnail-strip">
                <img 
                  *ngFor="let imagePath of selectedIssue.image_urls; trackBy: trackByImagePath; let i = index"
                  [src]="getImageUrl(imagePath)" 
                  [alt]="'Issue documentation ' + (i + 1)"
                  (click)="selectedImage = getImageUrl(imagePath)"
                  [class.active]="selectedImage === getImageUrl(imagePath)"
                  class="thumbnail"
                  loading="lazy"
                >
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Date Picker Modal for Verification -->
      <div class="modal-overlay" *ngIf="showDateModal" (click)="closeDateModal()" role="dialog" aria-modal="true">
        <div class="modal-content date-modal" (click)="$event.stopPropagation()">
          <div class="modal-header">
            <h3>Mark Issue as Seen</h3>
            <button class="close-btn" (click)="closeDateModal()" aria-label="Close modal">
              <i class="bi bi-x-lg"></i>
            </button>
          </div>
          
          <div class="modal-body">
            <div class="form-group">
              <label for="fixedDate">Date Fixed:</label>
              <input 
                type="date" 
                id="fixedDate" 
                [(ngModel)]="fixedDate" 
                [max]="getTodayDate()"
                class="date-input"
                required
              >
            </div>
            
            <div class="issue-summary" *ngIf="selectedIssueForVerification">
              <h4>Issue Summary</h4>
              <div class="summary-details">
                <div class="detail-row">
                  <span class="label">Vehicle:</span>
                  <span class="value">{{ selectedIssueForVerification.van_registration }}</span>
                </div>
                <div class="detail-row">
                  <span class="label">Driver:</span>
                  <span class="value">{{ selectedIssueForVerification.driver_name }}</span>
                </div>
                <div class="detail-row">
                  <span class="label">Issue:</span>
                  <span class="value">{{ selectedIssueForVerification.driver_comments }}</span>
                </div>
              </div>
            </div>
          </div>
          
          <div class="modal-footer">
            <button class="btn-cancel" (click)="closeDateModal()">
              <i class="bi bi-x"></i>
              Cancel
            </button>
            <button 
              class="btn-confirm" 
              (click)="confirmVerification()" 
              [disabled]="!fixedDate || isVerifying[selectedIssueForVerification?.id || '']"
            >
              <i class="bi bi-check-circle" *ngIf="!isVerifying[selectedIssueForVerification?.id || '']"></i>
              <i class="bi bi-arrow-clockwise spin" *ngIf="isVerifying[selectedIssueForVerification?.id || '']"></i>
              {{ isVerifying[selectedIssueForVerification?.id || ''] ? 'Processing...' : 'Confirm' }}
            </button>
          </div>
        </div>
      </div>

      <!-- Custom Report Modal -->
      <div class="modal-overlay" *ngIf="showReportModal" (click)="closeVanIssuesReportModal()" role="dialog" aria-modal="true">
        <div class="modal-content report-modal" (click)="$event.stopPropagation()">
          <div class="modal-header">
            <h3>Generate Custom Report</h3>
            <button class="close-btn" (click)="closeVanIssuesReportModal()" aria-label="Close modal">
              <i class="bi bi-x-lg"></i>
            </button>
          </div>
          
          <div class="modal-body">
            <div class="filter-section">
              <h4>Report Filters</h4>
              
              <!-- Status Filter -->
              <div class="form-group">
                <label>Status:</label>
                <div class="radio-group">
                  <label class="radio-option">
                    <input type="radio" [(ngModel)]="reportFilters.verified" [value]="null" name="status">
                    <span>All Issues</span>
                  </label>
                  <label class="radio-option">
                    <input type="radio" [(ngModel)]="reportFilters.verified" [value]="true" name="status">
                    <span>Verified Only</span>
                  </label>
                  <label class="radio-option">
                    <input type="radio" [(ngModel)]="reportFilters.verified" [value]="false" name="status">
                    <span>Pending Only</span>
                  </label>
                </div>
              </div>
              
              <!-- Date Range Filter -->
              <div class="form-group">
                <label>Date Range:</label>
                <div class="date-range">
                  <input 
                    type="date" 
                    [(ngModel)]="reportFilters.startDate" 
                    placeholder="Start Date"
                    class="date-input"
                  >
                  <span class="date-separator">to</span>
                  <input 
                    type="date" 
                    [(ngModel)]="reportFilters.endDate" 
                    placeholder="End Date"
                    class="date-input"
                  >
                </div>
              </div>
              
              <!-- Vehicle Filter -->
              <div class="form-group" *ngIf="availableVehicles.length > 0">
                <label>Vehicles:</label>
                <div class="checkbox-group">
                  <label class="checkbox-option" *ngFor="let vehicle of availableVehicles">
                    <input 
                      type="checkbox" 
                      [checked]="reportFilters.vehicles.includes(vehicle)"
                      (change)="onVanIssuesVehicleSelectionChange(vehicle, $event)"
                    >
                    <span>{{ vehicle }}</span>
                  </label>
                </div>
              </div>
            </div>
          </div>
          
          <div class="modal-footer">
            <button class="btn-cancel" (click)="closeVanIssuesReportModal()">
              <i class="bi bi-x"></i>
              Cancel
            </button>
            <button 
              class="btn-generate" 
              (click)="generateVanIssuesPdfReport()" 
              [disabled]="isGeneratingReport"
            >
              <i class="bi bi-file-earmark-pdf" *ngIf="!isGeneratingReport"></i>
              <i class="bi bi-arrow-clockwise spin" *ngIf="isGeneratingReport"></i>
              {{ isGeneratingReport ? 'Generating...' : 'Generate Report' }}
            </button>
            <button 
              class="btn-generate detailed" 
              (click)="generateVanIssuesDetailedPdfReport()" 
              [disabled]="isGeneratingReport"
            >
              <i class="bi bi-file-earmark-text" *ngIf="!isGeneratingReport"></i>
              <i class="bi bi-arrow-clockwise spin" *ngIf="isGeneratingReport"></i>
              {{ isGeneratingReport ? 'Generating...' : 'Detailed Report' }}
            </button>
          </div>
        </div>
      </div>

      <!-- Upload Repair Receipts Modal -->
      <div class="modal-overlay" *ngIf="showReceiptUploadModal" (click)="closeReceiptUploadModal()" role="dialog" aria-modal="true">
        <div class="modal-content receipt-upload-modal" (click)="$event.stopPropagation()">
          
          <!-- Modal Header -->
          <div class="modal-header">
            <h4>
              <i class="bi bi-cloud-upload"></i>
              Upload Repair Receipts
            </h4>
            <button class="close-btn" (click)="closeReceiptUploadModal()" aria-label="Close receipt upload">
              <i class="bi bi-x-lg"></i>
            </button>
          </div>
          
          <!-- Modal Body -->
          <div class="modal-body">
            
            <!-- Issue Summary -->
            <div *ngIf="selectedIssueForReceipts" class="issue-summary">
              <h5>Issue Details:</h5>
              <div class="summary-details">
                <p><strong>Vehicle:</strong> {{ selectedIssueForReceipts.van_registration }}</p>
                <p><strong>Driver:</strong> {{ selectedIssueForReceipts.driver_name }}</p>
                <p><strong>Date:</strong> {{ formatVanIssueDate(selectedIssueForReceipts.created_at) }}</p>
              </div>
            </div>

            <!-- File Upload Section -->
            <div class="upload-section">
              <div class="upload-instructions">
                <h5>Upload Repair Receipt Images</h5>
                <p>Select one or more images of repair receipts (JPG, PNG, GIF). Maximum 5MB per file.</p>
              </div>
              
              <div class="file-input-container">
                <input 
                  type="file" 
                  id="receiptFiles"
                  accept="image/*"
                  multiple
                  (change)="onReceiptFilesSelected($event)"
                  [disabled]="isUploadingReceipts"
                  class="file-input"
                >
                <label for="receiptFiles" class="file-input-label" [class.disabled]="isUploadingReceipts">
                  <i class="bi bi-cloud-upload"></i>
                  {{ isUploadingReceipts ? 'Uploading...' : 'Choose Receipt Images' }}
                </label>
              </div>
              
              <!-- Upload Progress -->
              <div *ngIf="isUploadingReceipts" class="upload-progress">
                <div class="progress-bar">
                  <div class="progress-fill" [style.width.%]="uploadProgress"></div>
                </div>
                <span class="progress-text">{{ uploadProgress }}% uploaded</span>
              </div>
            </div>

            <!-- Existing Receipts -->
            <div *ngIf="selectedIssueForReceipts && hasRepairReceipts(selectedIssueForReceipts)" class="existing-receipts">
              <h5>Current Repair Receipts:</h5>
              <div class="receipt-gallery">
                <div 
                  *ngFor="let receiptPath of selectedIssueForReceipts.repair_receipt_urls; trackBy: trackByReceiptPath"
                  class="receipt-item"
                >
                  <img 
                    [src]="getReceiptImageUrl(receiptPath)" 
                    [alt]="'Repair receipt'"
                    (click)="openVanIssueImageModal(getReceiptImageUrl(receiptPath), selectedIssueForReceipts)"
                    class="receipt-thumbnail"
                    loading="lazy"
                  >
                  <button 
                    class="delete-receipt-btn"
                    (click)="deleteReceiptImage(selectedIssueForReceipts, receiptPath)"
                    title="Delete receipt"
                  >
                    <i class="bi bi-trash"></i>
                  </button>
                </div>
              </div>
            </div>
            
          </div>
          
          <!-- Modal Footer -->
          <div class="modal-footer">
            <button class="cancel-btn" (click)="closeReceiptUploadModal()">
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Rejected Orders Tab Content -->
    <div *ngIf="activeTab === 'rejected-orders'" class="tab-content">
      <!-- List View -->
      <div *ngIf="rejectedOrdersViewMode === 'list'">
        <!-- Filters Section -->
        <div class="filters-section">
          <div class="filters-row">
            <div class="filter-group">
              <label for="rejectedOrdersSearchTerm">Search Orders</label>
              <input
                type="text"
                id="rejectedOrdersSearchTerm"
                [(ngModel)]="rejectedOrdersSearchTerm"
                (input)="filterRejectedOrders()"
                placeholder="Search by driver, route, store, or vehicle..."
                class="filter-input"
              >
            </div>
            
            <div class="filter-group">
              <label for="rejectedOrdersDateFilter">Filter by Date</label>
              <input
                type="date"
                id="rejectedOrdersDateFilter"
                [(ngModel)]="rejectedOrdersDateFilter"
                (change)="filterRejectedOrders()"
                class="filter-input"
              >
            </div>
            
            <div class="filter-actions">
              <button class="btn-refresh" (click)="loadRejectedOrders()">
                <i class="bi bi-arrow-clockwise"></i>
                Refresh
              </button>
            </div>
          </div>
        </div>

        <!-- Loading State -->
        <div *ngIf="rejectedOrdersLoading" class="loading-state">
          <div class="spinner"></div>
          <p>Loading rejected orders...</p>
        </div>

        <!-- No Data State -->
        <div *ngIf="!rejectedOrdersLoading && rejectedOrders.length === 0" class="no-data-state">
          <i class="bi bi-x-circle"></i>
          <h3>No Rejected Orders Found</h3>
          <p>No damaged product reports have been submitted yet.</p>
        </div>

        <!-- Rejected Orders Table -->
        <div *ngIf="!rejectedOrdersLoading && rejectedOrders.length > 0" class="reports-table-container">
          <table class="reports-table">
            <thead>
              <tr>
                <th>Submitted</th>
                <th>Date</th>
                <th>Driver</th>
                <th>Route</th>
                <th>Vehicle</th>
                <th>Store</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let order of (rejectedOrdersSearchTerm || rejectedOrdersDateFilter ? filteredRejectedOrders : rejectedOrders)">
                <td>{{ formatDate(order.created_at) }}</td>
                <td>{{ order.date }}</td>
                <td>{{ order.driver_name }}</td>
                <td>{{ order.route_number }}</td>
                <td>{{ order.van_registration }}</td>
                <td>
                  <div class="store-info">
                    <div>{{ order.store_name }}</div>
                    <small>Drop #{{ order.drop_number_on_route }}</small>
                  </div>
                </td>
                <td class="actions-cell">
                  <div class="action-buttons">
                    <button class="btn-view" (click)="viewRejectedOrderDetails(order)">
                      <i class="bi bi-eye"></i>
                      View
                    </button>
                    <button class="btn-pdf" (click)="downloadRejectedOrderPDF(order)">
                      <i class="bi bi-file-pdf"></i>
                      PDF
                    </button>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Detail View -->
      <div *ngIf="rejectedOrdersViewMode === 'detail' && selectedRejectedOrder" class="rejected-order-detail-view">
        <!-- Clean Header -->
        <div class="detail-header">
          <button class="back-btn" (click)="backToRejectedOrdersList()">
            <i class="bi bi-arrow-left"></i>
            Back to List
          </button>
          <h1>Rejected Order Report</h1>
          <span class="report-date">{{ formatDate(selectedRejectedOrder.created_at) }}</span>
          <button class="pdf-download-btn" (click)="downloadRejectedOrderPDF(selectedRejectedOrder)">
            <i class="bi bi-file-earmark-pdf"></i>
            Download PDF
          </button>
        </div>

        <!-- Content Sections -->
        <div class="detail-content">
          <!-- Driver & Route Section -->
          <div class="info-section">
            <h3>Driver & Route Information</h3>
            <div class="info-grid">
              <div class="info-item">
                <label>Driver Name</label>
                <span class="driver-name">{{ selectedRejectedOrder.driver_name }}</span>
              </div>
              <div class="info-item">
                <label>Date</label>
                <span>{{ selectedRejectedOrder.date }}</span>
              </div>
              <div class="info-item">
                <label>Route Number</label>
                <span class="route-number">{{ selectedRejectedOrder.route_number }}</span>
              </div>
              <div class="info-item">
                <label>Vehicle Registration</label>
                <span class="vehicle-reg">{{ selectedRejectedOrder.van_registration }}</span>
              </div>
            </div>
          </div>

          <!-- Store & Delivery Section -->
          <div class="info-section">
            <h3>Store & Delivery Information</h3>
            <div class="store-header">
              <span class="store-name">{{ selectedRejectedOrder.store_name }}</span>
              <span class="drop-number">Drop #{{ selectedRejectedOrder.drop_number_on_route }}</span>
            </div>
            <div class="info-grid">
              <div class="info-item">
                <label>Arrival Time</label>
                <span>{{ selectedRejectedOrder.arrival_time_at_store }}</span>
              </div>
              <div class="info-item">
                <label>Wait Time</label>
                <span>{{ selectedRejectedOrder.wait_time_in_store }} minutes</span>
              </div>
              <div class="info-item">
                <label>Driving Start Time</label>
                <span>{{ selectedRejectedOrder.driving_start_time }}</span>
              </div>
              <div class="info-item">
                <label>Crates Delivered</label>
                <span>{{ selectedRejectedOrder.number_of_crates_into_store }}</span>
              </div>
              <div class="info-item">
                <label>Van Temperature</label>
                <span class="temperature-reading" [class.high]="selectedRejectedOrder.van_temp_by_display > 5">
                  {{ selectedRejectedOrder.van_temp_by_display }}C
                </span>
              </div>
              <div class="info-item">
                <label>Site Keys Available</label>
                <span class="yes-no" [class.yes]="selectedRejectedOrder.site_keys === 'yes'" [class.no]="selectedRejectedOrder.site_keys === 'no'">
                  {{ selectedRejectedOrder.site_keys === 'yes' ? 'Yes' : 'No' }}
                </span>
              </div>
            </div>
          </div>

          <!-- Damage Assessment Section -->
          <div class="info-section damage-section">
            <h3>Damage Assessment</h3>
            <div class="damage-grid">
              <div class="damage-question">
                <span class="question">Order damaged before loading?</span>
                <span class="answer" [class.yes]="selectedRejectedOrder.order_damaged_before_loading === 'yes'" [class.no]="selectedRejectedOrder.order_damaged_before_loading === 'no'">
                  {{ selectedRejectedOrder.order_damaged_before_loading === 'yes' ? 'Yes' : 'No' }}
                </span>
              </div>
              <div class="damage-question">
                <span class="question">All products damaged?</span>
                <span class="answer" [class.severe]="selectedRejectedOrder.all_products_damaged === 'yes'" [class.partial]="selectedRejectedOrder.all_products_damaged === 'no'">
                  {{ selectedRejectedOrder.all_products_damaged === 'yes' ? 'Yes - All Damaged' : 'No - Partial' }}
                </span>
              </div>
              <div class="damage-question">
                <span class="question">Shortages marked on docket?</span>
                <span class="answer" [class.yes]="selectedRejectedOrder.marked_shortages_on_docket === 'yes'" [class.no]="selectedRejectedOrder.marked_shortages_on_docket === 'no'">
                  {{ selectedRejectedOrder.marked_shortages_on_docket === 'yes' ? 'Yes' : 'No' }}
                </span>
              </div>
              <div class="damage-question">
                <span class="question">Know how product was damaged?</span>
                <span class="answer" [class.yes]="selectedRejectedOrder.know_how_product_damaged === 'yes'" [class.no]="selectedRejectedOrder.know_how_product_damaged === 'no'">
                  {{ selectedRejectedOrder.know_how_product_damaged === 'yes' ? 'Yes' : 'No' }}
                </span>
              </div>
            </div>
          </div>

          <!-- Comments Section -->
          <div class="info-section" *ngIf="selectedRejectedOrder.comments_vehicle_issues || selectedRejectedOrder.comments_delivery_issues || selectedRejectedOrder.comments_complaints || selectedRejectedOrder.comments_returns || selectedRejectedOrder.comments_accidents">
            <h3>Additional Comments</h3>
            <div class="comments-list">
              <div class="comment" *ngIf="selectedRejectedOrder.comments_vehicle_issues">
                <strong>Vehicle Issues:</strong>
                <p>{{ selectedRejectedOrder.comments_vehicle_issues }}</p>
              </div>
              <div class="comment" *ngIf="selectedRejectedOrder.comments_delivery_issues">
                <strong>Delivery Issues:</strong>
                <p>{{ selectedRejectedOrder.comments_delivery_issues }}</p>
              </div>
              <div class="comment" *ngIf="selectedRejectedOrder.comments_complaints">
                <strong>Complaints:</strong>
                <p>{{ selectedRejectedOrder.comments_complaints }}</p>
              </div>
              <div class="comment" *ngIf="selectedRejectedOrder.comments_returns">
                <strong>Returns:</strong>
                <p>{{ selectedRejectedOrder.comments_returns }}</p>
              </div>
              <div class="comment" *ngIf="selectedRejectedOrder.comments_accidents">
                <strong>Accidents:</strong>
                <p>{{ selectedRejectedOrder.comments_accidents }}</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Temperature Reports Tab Content -->
    <div *ngIf="activeTab === 'temperature-reports'" class="tab-content">
      <!-- List View -->
      <div *ngIf="temperatureReportsViewMode === 'list'">
        <!-- Filters Section -->
        <div class="filters-section">
          <div class="filters-row">
            <div class="filter-group">
              <label for="temperatureSearchTerm">Search Reports</label>
              <input
                type="text"
                id="temperatureSearchTerm"
                [(ngModel)]="temperatureReportsSearchTerm"
                (input)="filterTemperatureReports()"
                placeholder="Search by driver name, vehicle registration, or store..."
                class="filter-input"
              >
            </div>
            
            <div class="filter-group">
              <label for="temperatureDateFilter">Filter by Date</label>
              <input
                type="date"
                id="temperatureDateFilter"
                [(ngModel)]="temperatureReportsDateFilter"
                (change)="filterTemperatureReports()"
                class="filter-input"
              >
            </div>
            
            <div class="filter-actions">
              <button class="btn-refresh" (click)="loadTemperatureReports()">
                <i class="bi bi-arrow-clockwise"></i>
                Refresh
              </button>
            </div>
          </div>
        </div>

        <!-- Loading State -->
        <div *ngIf="temperatureReportsLoading" class="loading-state">
          <div class="spinner"></div>
          <p>Loading temperature reports...</p>
        </div>

        <!-- No Reports State -->
        <div *ngIf="!temperatureReportsLoading && temperatureReports.length === 0" class="no-data-state">
          <i class="bi bi-thermometer-half"></i>
          <h3>No Temperature Reports Found</h3>
          <p>No temperature issue reports have been submitted yet.</p>
        </div>

        <!-- Temperature Reports Table -->
        <div *ngIf="!temperatureReportsLoading && temperatureReports.length > 0" class="reports-table-container">
          <table class="reports-table">
            <thead>
              <tr>
                <th>Submitted</th>
                <th>Date</th>
                <th>Driver</th>
                <th>Route</th>
                <th>Vehicle</th>
                <th>Store</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let report of (temperatureReportsSearchTerm || temperatureReportsDateFilter ? filteredTemperatureReports : temperatureReports)">
                <td>{{ formatDate(report.created_at) }}</td>
                <td>{{ report.date }}</td>
                <td>{{ report.driver_name }}</td>
                <td>{{ report.route_number }}</td>
                <td>{{ report.van_registration }}</td>
                <td>
                  <div class="store-info">
                    <div>{{ report.store_name }}</div>
                    <small>Drop #{{ report.drop_number_on_route }}</small>
                  </div>
                </td>
                <td class="actions-cell">
                  <div class="action-buttons">
                    <button class="btn-view" (click)="viewTemperatureReportDetails(report)">
                      <i class="bi bi-eye"></i>
                      View
                    </button>
                    <button class="btn-pdf" (click)="downloadTemperatureReportPDF(report)">
                      <i class="bi bi-file-pdf"></i>
                      PDF
                    </button>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Detail View -->
      <div *ngIf="temperatureReportsViewMode === 'detail' && selectedTemperatureReport" class="rejected-order-detail-view">
        <!-- Clean Header -->
        <div class="detail-header">
          <button class="back-btn" (click)="backToTemperatureReportsList()">
            <i class="bi bi-arrow-left"></i>
            Back to List
          </button>
          <h1>Temperature Issue Report</h1>
          <span class="report-date">{{ formatDate(selectedTemperatureReport.created_at) }}</span>
          <button class="pdf-download-btn" (click)="downloadTemperatureReportPDF(selectedTemperatureReport)">
            <i class="bi bi-file-earmark-pdf"></i>
            Download PDF
          </button>
        </div>

        <!-- Content Sections -->
        <div class="detail-content">
          <!-- Driver & Route Section -->
          <div class="info-section">
            <h3>Driver & Route Information</h3>
            <div class="info-grid">
              <div class="info-item">
                <label>Driver Name</label>
                <span class="driver-name">{{ selectedTemperatureReport.driver_name }}</span>
              </div>
              <div class="info-item">
                <label>Date</label>
                <span>{{ selectedTemperatureReport.date }}</span>
              </div>
              <div class="info-item">
                <label>Route Number</label>
                <span class="route-number">{{ selectedTemperatureReport.route_number }}</span>
              </div>
              <div class="info-item">
                <label>Vehicle Registration</label>
                <span class="vehicle-reg">{{ selectedTemperatureReport.van_registration }}</span>
              </div>
            </div>
          </div>

          <!-- Store & Delivery Section -->
          <div class="info-section">
            <h3>Store & Delivery Information</h3>
            <div class="store-header">
              <span class="store-name">{{ selectedTemperatureReport.store_name }}</span>
              <span class="drop-number">Drop #{{ selectedTemperatureReport.drop_number_on_route }}</span>
            </div>
            <div class="info-grid">
              <div class="info-item">
                <label>Arrival Time</label>
                <span>{{ selectedTemperatureReport.arrival_time_at_store }}</span>
              </div>
              <div class="info-item">
                <label>Wait Time</label>
                <span>{{ selectedTemperatureReport.wait_time_at_store }} minutes</span>
              </div>
              <div class="info-item">
                <label>Driving Start Time</label>
                <span>{{ selectedTemperatureReport.driving_start_time }}</span>
              </div>
              <div class="info-item">
                <label>Total Crates</label>
                <span>{{ selectedTemperatureReport.total_crates_into_store }}</span>
              </div>
              <div class="info-item">
                <label>Van Temperature</label>
                <span class="temperature-reading" [class.high]="selectedTemperatureReport.van_temp_by_display > 5">
                  {{ selectedTemperatureReport.van_temp_by_display }}C
                </span>
              </div>
              <div class="info-item">
                <label>Site Keys Available</label>
                <span class="yes-no" [class.yes]="selectedTemperatureReport.site_keys === 'yes'" [class.no]="selectedTemperatureReport.site_keys === 'no'">
                  {{ selectedTemperatureReport.site_keys === 'yes' ? 'Yes' : 'No' }}
                </span>
              </div>
            </div>
          </div>

          <!-- Temperature Monitoring Section -->
          <div class="info-section">
            <h3>Temperature Monitoring</h3>
            <div class="info-grid">
              <div class="info-item">
                <label>Van Temperature (Display)</label>
                <span class="temperature-reading" [class.high]="selectedTemperatureReport.van_temp_by_display > 5">
                  {{ selectedTemperatureReport.van_temp_by_display }}C
                </span>
              </div>
              <div class="info-item">
                <label>Probe Serial Number</label>
                <span>{{ selectedTemperatureReport.probe_serial_number }}</span>
              </div>
              <div class="info-item">
                <label>Probe Temperature</label>
                <span class="temperature-reading" [class.high]="selectedTemperatureReport.probe_temperature > 5">
                  {{ selectedTemperatureReport.probe_temperature }}C
                </span>
              </div>
              <div class="info-item">
                <label>Customer Temperature</label>
                <span class="temperature-reading" [class.high]="selectedTemperatureReport.customer_temperature > 5">
                  {{ selectedTemperatureReport.customer_temperature }}C
                </span>
              </div>
            </div>
          </div>

          <!-- Testing & Environmental Section -->
          <div class="info-section">
            <h3>Testing & Environmental Data</h3>
            <div class="info-grid">
              <div class="info-item">
                <label>Destroyed Pack for Testing</label>
                <span class="yes-no" [class.yes]="selectedTemperatureReport.destroyed_pack_for_testing === 'yes'" [class.no]="selectedTemperatureReport.destroyed_pack_for_testing === 'no'">
                  {{ selectedTemperatureReport.destroyed_pack_for_testing === 'yes' ? 'Yes' : 'No' }}
                </span>
              </div>
              <div class="info-item">
                <label>Used Pack in Van for Testing</label>
                <span class="yes-no" [class.yes]="selectedTemperatureReport.used_pack_in_van_for_testing === 'yes'" [class.no]="selectedTemperatureReport.used_pack_in_van_for_testing === 'no'">
                  {{ selectedTemperatureReport.used_pack_in_van_for_testing === 'yes' ? 'Yes' : 'No' }}
                </span>
              </div>
              <div class="info-item">
                <label>Weather Conditions</label>
                <span>{{ selectedTemperatureReport.weather_conditions }}</span>
              </div>
              <div class="info-item">
                <label>Products Sampled</label>
                <span>{{ selectedTemperatureReport.full_name_of_products_sampled }}</span>
              </div>
            </div>
          </div>

          <!-- Photo Documentation Section -->
          <div class="info-section" *ngIf="selectedTemperatureReport.photo_temp_reading_customer || selectedTemperatureReport.photo_van_display_temp || selectedTemperatureReport.photo_probe_reading_destructive_pack">
            <h3>Photo Documentation</h3>
            <div class="photo-documentation">
              <div class="photo-grid">
                <div class="photo-item" *ngIf="selectedTemperatureReport.photo_temp_reading_customer">
                  <label>Customer Temperature Reading</label>
                  <img [src]="selectedTemperatureReport.photo_temp_reading_customer" alt="Customer Temperature" (click)="openImageModal(selectedTemperatureReport.photo_temp_reading_customer)">
                </div>
                <div class="photo-item" *ngIf="selectedTemperatureReport.photo_van_display_temp">
                  <label>Van Display Temperature</label>
                  <img [src]="selectedTemperatureReport.photo_van_display_temp" alt="Van Display" (click)="openImageModal(selectedTemperatureReport.photo_van_display_temp)">
                </div>
                <div class="photo-item" *ngIf="selectedTemperatureReport.photo_probe_reading_destructive_pack">
                  <label>Probe Reading from Destructive Pack</label>
                  <img [src]="selectedTemperatureReport.photo_probe_reading_destructive_pack" alt="Probe Reading" (click)="openImageModal(selectedTemperatureReport.photo_probe_reading_destructive_pack)">
                </div>
              </div>
            </div>
          </div>

          <!-- Comments Section -->
          <div class="info-section" *ngIf="selectedTemperatureReport.further_comments">
            <h3>Additional Information</h3>
            <div class="comments-list">
              <div class="comment">
                <strong>Further Comments:</strong>
                <p>{{ selectedTemperatureReport.further_comments }}</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Image Modal -->
  <div *ngIf="showImageModal" class="image-modal" (click)="closeImageModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <button class="modal-close" (click)="closeImageModal()">
        <i class="bi bi-x-lg"></i>
      </button>
      <img [src]="selectedImageUrl" alt="Accident Image" class="modal-image">
    </div>
  </div>
</div> 