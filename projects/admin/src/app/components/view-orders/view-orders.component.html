<div class="view-orders-container">
  <!-- Main navigation bar -->
  <header class="navbar">
    <div class="logo">OPTIROUTE</div>
    <div class="nav-links">
      <a class="nav-pill" routerLink="/dashboard">
        <i class="bi bi-arrow-left"></i> Back to Dashboard
      </a>
    </div>
  </header>

  <!-- Sub-navigation bar -->
  <div class="sub-navbar">
    <div class="nav-tabs">
      <a class="nav-tab" routerLink="/route-planner">
        <i class="bi bi-map"></i> Route Map
      </a>
      <a class="nav-tab" routerLink="/route-planner" [queryParams]="{import: true}">
        <i class="bi bi-file-earmark-arrow-up"></i> Order Import
      </a>
      <a class="nav-tab active">
        <i class="bi bi-list-check"></i> View Orders
      </a>
    </div>
  </div>

  <div class="content">
    <div class="page-header">
      <h2 class="page-title">View Orders</h2>
      <button class="refresh-button" (click)="refreshOrders()">
        <i class="bi bi-arrow-clockwise"></i> Refresh
      </button>
    </div>

    <div *ngIf="isLoading" class="loading-spinner">
      <p><i class="bi bi-hourglass-split"></i> Loading orders...</p>
    </div>

    <div *ngIf="isProcessing" class="loading-spinner">
      <p><i class="bi bi-hourglass-split"></i> Processing masterfile matches...</p>
    </div>

    <div *ngIf="successMessage" class="alert alert-success">
      {{ successMessage }}
    </div>

    <div *ngIf="errorMessage" class="alert alert-danger">
      {{ errorMessage }}
    </div>

    <div *ngIf="!isLoading && !errorMessage && orders.length === 0" class="no-orders">
      <p>No orders found. Orders will appear here after they are imported.</p>
    </div>

    <div *ngIf="orders.length > 0" class="orders-list">
      <div *ngFor="let order of orders" class="order-card">
        <!-- Order Header -->
        <div class="order-header">
          <div class="order-summary" (click)="toggleOrderExpand(order.id!)">
            <i class="bi" [ngClass]="isOrderExpanded(order.id!) ? 'bi-chevron-down' : 'bi-chevron-right'"></i>
            <span class="file-name">{{ order.fileName }}</span>
            <div class="order-badges">
              <span class="date-badge">Delivery: {{ order.deliveryDate | date }}</span>
              <span class="date-badge">Imported: {{ order.importDate | date }}</span>
              <span class="routes-badge">{{ order.routes.length }} routes</span>
            </div>
          </div>
          <div class="order-actions">
            <button class="btn btn-info" (click)="showRouteFilterForMatches(order.id!); $event.stopPropagation();">
              <i class="bi bi-eye"></i> View Matches
            </button>
          </div>
        </div>
        
        <!-- Order Details (collapsible) -->
        <div *ngIf="isOrderExpanded(order.id!)" class="order-details">
          <div *ngFor="let route of order.routes" class="route-section">
            <!-- Route Header -->
            <div class="route-header" (click)="toggleRouteExpand(order.id!, route.id!)">
              <div class="route-summary">
                <i class="bi" [ngClass]="isRouteExpanded(order.id!, route.id!) ? 'bi-chevron-down' : 'bi-chevron-right'"></i>
                <span class="route-name">{{ route.name }}</span>
                <span class="route-number" *ngIf="route.routeNumber">#{{ route.routeNumber }}</span>
                <span class="driver-name" *ngIf="route.driverName">Driver: {{ route.driverName }}</span>
                <div class="route-metrics">
                  <span class="stores-count">{{ calculateTotalStores(route) }} stores</span>
                  <span class="items-count">{{ calculateTotalItems(route) }} items</span>
                  <span class="crate-count">{{ route.crateCount || calculateCrateCount(route) }} crates</span>
                </div>
              </div>
            </div>
            
            <!-- Route Details (collapsible) -->
            <div *ngIf="isRouteExpanded(order.id!, route.id!)" class="route-details">
              <div *ngFor="let store of route.stores" class="store-item">
                <div class="store-info">
                  <span class="store-name">{{ store.customerName }}</span>
                  <span class="store-code" *ngIf="store.customerCode">({{ store.customerCode }})</span>
                  <span class="store-items">{{ store.totalItems }} items</span>
                  <span class="store-status" [ngClass]="'status-' + store.status">{{ store.status }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Add Modal for Masterfile Matches -->
<div class="modal-backdrop" *ngIf="showMatchesModal" (click)="closeMatchesModal()"></div>
<div class="matches-modal" *ngIf="showMatchesModal">
  <div class="modal-header">
    <h3>Masterfile Matches - Order #{{selectedOrderId}}</h3>
    <button class="close-button" (click)="closeMatchesModal()">Ã—</button>
  </div>
  <div class="modal-body">
    <div *ngIf="isLoadingMatches" class="loading-spinner">
      <p><i class="bi bi-hourglass-split"></i> Loading matches...</p>
    </div>
    
    <div *ngIf="!isLoadingMatches && masterfileMatches.length === 0 && unmatchedStores.length === 0" class="no-matches">
      <p>No matches found. Please process masterfile matches first.</p>
    </div>
    
    <div *ngIf="masterfileMatches.length > 0 || unmatchedStores.length > 0" class="matches-list">
      <div class="match-summary">
        <strong>Found {{masterfileMatches.length}} matches out of {{masterfileMatches.length + unmatchedStores.length}} stores ({{getMatchPercentage()}}%)</strong>
        <span class="badge badge-success">{{getMatchTypeCount('store_code_match')}} store code</span>
        <span class="badge badge-info">{{getMatchTypeCount('dispatch_code_match')}} dispatch</span>
        <span class="badge badge-warning">{{getMatchTypeCount('address_match')}} manual check</span>
        <span class="badge badge-info">{{getMatchTypeCount('name_exact_match')}} exact name</span>
        <span class="badge badge-warning">{{getMatchTypeCount('name_match')}} partial</span>
        <span class="badge badge-danger">{{getMatchTypeCount('name_fuzzy_match')}} similar</span>
        <span class="badge badge-danger">{{unmatchedStores.length}} unmatched</span>
      </div>
      
      <!-- Matched Stores Table -->
      <div *ngIf="masterfileMatches.length > 0">
        <h4 class="section-title">Matched Stores</h4>
        <div class="table-responsive">
          <table class="matches-table">
            <thead>
              <tr>
                <th colspan="3" class="section-header order-section">Order Information</th>
                <th colspan="4" class="section-header master-section">Masterfile Information</th>
              </tr>
              <tr>
                <th>Store Name</th>
                <th>Code</th>
                <th>Items</th>
                <th>Master Store</th>
                <th>Address</th>
                <th>Codes</th>
                <th>Match</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let match of masterfileMatches" class="match-row">
                <!-- Order Information Section -->
                <td class="order-data store-name">
                  <strong>{{match.customer_name}}</strong>
                </td>
                <td class="order-data code">
                  <span *ngIf="match.customer_code" class="code-badge">{{match.customer_code}}</span>
                  <span *ngIf="!match.customer_code">-</span>
                </td>
                <td class="order-data items">
                  <span class="items-badge">{{match.total_items}}</span>
                </td>
                
                <!-- Master File Information Section -->
                <td class="master-data store-name">
                  <strong>{{match.store_name || 'N/A'}}</strong>
                  <div class="company" *ngIf="match.store_company">{{match.store_company}}</div>
                </td>
                <td class="master-data address">
                  {{match.address_line_1 || 'No address'}}
                  <div class="eircode" *ngIf="match.eircode">{{match.eircode}}</div>
                </td>
                <td class="master-data codes">
                  <div class="codes-container">
                    <div class="code-row" *ngIf="match.dispatch_code">
                      <span class="code-label">Dispatch:</span> 
                      <span class="dispatch-code" [class.highlight]="highlightMatch(match.dispatch_code, match.customer_name)">{{match.dispatch_code}}</span>
                    </div>
                    <div class="code-row" *ngIf="match.store_code">
                      <span class="code-label">Store:</span> 
                      <span class="store-code" [class.highlight]="match.customer_code && match.customer_code === match.store_code">{{match.store_code}}</span>
                    </div>
                    <div class="code-row" *ngIf="match.door_code">
                      <span class="code-label">Door:</span> <span class="code-value">{{match.door_code}}</span>
                    </div>
                    <div class="code-row" *ngIf="match.alarm_code">
                      <span class="code-label">Alarm:</span> <span class="code-value">{{match.alarm_code}}</span>
                    </div>
                  </div>
                </td>
                <td class="master-data match-type">
                  <div class="match-badge" 
                       [ngClass]="getMatchTypeClass(match.match_type)"
                       (click)="match.match_type === 'name_match' || match.match_type === 'name_fuzzy_match' || match.match_type === 'address_match' ? openStoreSelectModal(match) : null"
                       [style.cursor]="match.match_type === 'name_match' || match.match_type === 'name_fuzzy_match' || match.match_type === 'address_match' ? 'pointer' : 'default'"
                       [title]="match.match_type === 'manual_match' ? 'Manually verified match' : getMatchDetails(match)">
                    <i *ngIf="match.match_type === 'manual_match'" class="bi bi-check-circle-fill" style="margin-right: 4px;"></i>
                    {{getMatchTypeLabel(match.match_type)}}
                    <small class="match-details" *ngIf="match.match_type === 'dispatch_code_match' || match.match_type === 'store_code_match'">
                      {{getMatchDetails(match)}}
                    </small>
                  </div>
                  <button *ngIf="match.match_type !== 'manual_match'" 
                          class="btn btn-sm btn-success manual-match-btn"
                          (click)="openStoreSelectModal(match)">
                    Manual Match
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- Unmatched Stores Section -->
      <div *ngIf="unmatchedStores.length > 0" class="unmatched-stores">
        <h4 class="section-title">Unmatched Stores</h4>
        <div class="table-responsive">
          <table class="unmatched-table">
            <thead>
              <tr>
                <th>Store Name</th>
                <th>Code</th>
                <th>Items</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let store of unmatchedStores" class="unmatched-row">
                <td class="store-name">{{store.customerName}}</td>
                <td class="store-code">
                  <span *ngIf="store.customerCode" class="code-badge">{{store.customerCode}}</span>
                  <span *ngIf="!store.customerCode">-</span>
                </td>
                <td class="store-items">
                  <span class="items-badge">{{store.totalItems}}</span>
                </td>
                <td class="store-status">
                  <span class="status-badge">{{store.status || 'pending'}}</span>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Add Route Filter Modal -->
<div class="modal-backdrop" *ngIf="showFilterModal" (click)="closeFilterModal()"></div>
<div class="filter-modal" *ngIf="showFilterModal">
  <div class="modal-header">
    <h3>Select Routes to View</h3>
    <button class="close-button" (click)="closeFilterModal()">Ã—</button>
  </div>
  <div class="modal-body">
    <p class="instructions">Select which routes you want to include in the masterfile matches view:</p>
    
    <div class="filter-actions">
      <button class="btn btn-sm btn-outline-primary" (click)="selectAllRoutes(filterOrderId!)">Select All</button>
      <button class="btn btn-sm btn-outline-secondary" (click)="deselectAllRoutes(filterOrderId!)">Deselect All</button>
    </div>
    
    <div class="route-filter-list">
      <div *ngFor="let order of orders" [hidden]="order.id !== filterOrderId">
        <div *ngFor="let route of order.routes" class="route-filter-item">
          <label class="route-checkbox">
            <input type="checkbox" 
                   [checked]="isRouteFilterSelected(order.id!, route.id!)" 
                   (change)="toggleRouteFilter(order.id!, route.id!)">
            <span class="route-name">{{ route.name }}</span>
            <span class="route-stats">
              <span class="stores-count">{{ calculateTotalStores(route) }} stores</span>
              <span class="items-count">{{ calculateTotalItems(route) }} items</span>
              <span *ngIf="calculateManualChecksForRoute(order.id!, route.id!) | async as manualChecks" 
                    class="manual-checks-badge" 
                    [style.display]="manualChecks > 0 ? 'inline-block' : 'none'">
                {{ manualChecks }} Manual Checks
              </span>
            </span>
          </label>
        </div>
      </div>
    </div>
  </div>
  <div class="modal-footer">
    <button class="btn btn-primary" (click)="viewMasterfileMatchesWithFilters()">View Matches</button>
    <button class="btn btn-secondary" (click)="closeFilterModal()">Cancel</button>
  </div>
</div>

<!-- Add Store Selection Modal -->
<div class="modal-backdrop" *ngIf="showStoreSelectModal" (click)="closeStoreSelectModal()"></div>
<div class="store-select-modal" *ngIf="showStoreSelectModal">
  <div class="modal-header">
    <h3>Select Store from Masterfile</h3>
    <button class="close-button" (click)="closeStoreSelectModal()">Ã—</button>
  </div>
  <div class="modal-body">
    <div *ngIf="selectedMatch" class="original-store">
      <h4>Matching for:</h4>
      <div class="store-card">
        <div class="store-info">
          <span class="store-name">{{ selectedMatch.customer_name }}</span>
          <span *ngIf="selectedMatch.customer_code" class="store-code">({{ selectedMatch.customer_code }})</span>
        </div>
      </div>
    </div>
    
    <div class="search-box">
      <input 
        type="text" 
        placeholder="Search stores by name, code, or address..." 
        [value]="searchTerm"
        (input)="updateSearch($event)"
        class="search-input"
      >
    </div>
    
    <div class="store-list">
      <div *ngIf="filteredStoreOptions.length === 0" class="no-stores">
        <p>No matching stores found. Try adjusting your search.</p>
      </div>
      
      <div *ngFor="let store of filteredStoreOptions" class="store-option">
        <div class="store-header">
          <span class="store-name">{{ store.store_name || 'Unnamed Store' }}</span>
          <span class="store-company" *ngIf="store.store_company">({{ store.store_company }})</span>
        </div>
        <div class="store-details">
          <div class="detail-row" *ngIf="store.address_line_1">
            <span class="detail-label">Address:</span>
            <span class="detail-value">{{ store.address_line_1 }}</span>
          </div>
          <div class="detail-row" *ngIf="store.eircode">
            <span class="detail-label">Eircode:</span>
            <span class="detail-value">{{ store.eircode }}</span>
          </div>
          <div class="detail-row" *ngIf="store.dispatch_code">
            <span class="detail-label">Dispatch Code:</span>
            <span class="detail-value highlight">{{ store.dispatch_code }}</span>
          </div>
          <div class="detail-row" *ngIf="store.store_code">
            <span class="detail-label">Store Code:</span>
            <span class="detail-value highlight">{{ store.store_code }}</span>
          </div>
        </div>
        <div class="store-actions">
          <button class="btn btn-sm btn-primary" 
                 [disabled]="isSavingMatch" 
                 (click)="selectedStore = store; saveManualMatch()">
            {{isSavingMatch ? 'Saving...' : 'Save Match'}}
          </button>
        </div>
      </div>
    </div>
  </div>
  <div class="modal-footer">
    <button class="btn btn-secondary" (click)="closeStoreSelectModal()">Cancel</button>
  </div>
</div> 